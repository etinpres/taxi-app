<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ê³ ë„ë¹„ë§Œ íƒì‹œì¥ë¶€">
  <meta name="theme-color" content="#6366f1">
  <title>ê³ ë„ë¹„ë§Œ íƒì‹œì¥ë¶€</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸš•</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸš•</text></svg>">
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      overflow-x: hidden; 
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    input, textarea { 
      -webkit-user-select: text; 
      user-select: text; 
    }
    /* ëª¨ë“  ë²„íŠ¼ê³¼ ë²„íŠ¼ ë‚´ë¶€ ìš”ì†Œ ì„ íƒ ë°©ì§€ */
    button, button * {
      -webkit-user-select: none !important;
      user-select: none !important;
    }
    button div, button span {
      pointer-events: none;
    }
    * { -webkit-overflow-scrolling: touch; }
    
    /* ê¸¸ê²Œ ëˆ„ë¥´ê¸° ì‹œê°ì  í”¼ë“œë°± */
    .calendar-day-btn {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .calendar-day-btn.pressing {
      transform: scale(1.1);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* í† ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes slideInUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    @keyframes slideOutDown {
      from {
        transform: translateY(0);
        opacity: 1;
      }
      to {
        transform: translateY(100%);
        opacity: 0;
      }
    }
    .toast-enter {
      animation: slideInUp 0.3s ease-out;
    }
    .toast-exit {
      animation: slideOutDown 0.3s ease-in;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app"></div>
  
  <script>
    const App = {
      state: {
        transactions: [],
        categories: {
          income: ['ì¹´ì¹´ì˜¤íƒì‹œ', 'ì¹´ë“œê²°ì œ', 'í˜„ê¸ˆê²°ì œ', 'íŒ'],
          expense: ['ì‹ë¹„', 'êµí†µ', 'ì‡¼í•‘', 'ì·¨ë¯¸', 'ê³µê³¼ê¸ˆ', 'ê¸°íƒ€']
        },
        showForm: false,
        currentMonth: new Date(),
        showCategoryManager: false,
        selectedDate: null,
        headerExpanded: false,
        editingTransaction: null,
        newCategory: '',
        categoryType: 'expense',
        monthlyGoal: 0,
        showGoalInput: false,
        goalInputValue: '',
        daysOff: [],
        toastMessage: '',
        formData: {
          type: 'expense',
          amount: '',
          category: '',
          description: '',
          date: ''
        }
      },
      
      init() {
        this.loadData();
        this.render();
        this.registerServiceWorker();
      },
      
      getLocalDateString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      },
      
      loadData() {
        try {
          const saved = localStorage.getItem('transactions');
          if (saved) this.state.transactions = JSON.parse(saved);
        } catch (e) {
          console.error('Failed to load transactions:', e);
        }
        
        try {
          const savedCat = localStorage.getItem('categories');
          if (savedCat) this.state.categories = JSON.parse(savedCat);
        } catch (e) {
          console.error('Failed to load categories:', e);
        }
        
        try {
          const savedGoal = localStorage.getItem('monthlyGoal');
          if (savedGoal) this.state.monthlyGoal = parseInt(savedGoal);
        } catch (e) {
          console.error('Failed to load monthly goal:', e);
        }
        
        try {
          const savedDaysOff = localStorage.getItem('daysOff');
          if (savedDaysOff) this.state.daysOff = JSON.parse(savedDaysOff);
        } catch (e) {
          console.error('Failed to load days off:', e);
        }
      },
      
      saveData() {
        try {
          localStorage.setItem('transactions', JSON.stringify(this.state.transactions));
          localStorage.setItem('categories', JSON.stringify(this.state.categories));
          localStorage.setItem('monthlyGoal', this.state.monthlyGoal.toString());
          localStorage.setItem('daysOff', JSON.stringify(this.state.daysOff));
        } catch (e) {
          console.error('Failed to save data:', e);
        }
      },
      
      getSummary() {
        return this.state.transactions.reduce((acc, t) => {
          if (t.type === 'income') acc.income += t.amount;
          else acc.expense += t.amount;
          return acc;
        }, { income: 0, expense: 0 });
      },
      
      formatCurrency(amount) {
        return new Intl.NumberFormat('ko-KR').format(amount);
      },
      
      formatDate(dateString) {
        const date = new Date(dateString + 'T00:00:00');
        return `${date.getMonth() + 1}/${date.getDate()}`;
      },
      
      handleAmountChange(value) {
        const cleaned = value.replace(/,/g, '');
        if (cleaned === '' || /^\d+$/.test(cleaned)) {
          const formatted = cleaned === '' ? '' : parseInt(cleaned).toLocaleString('ko-KR');
          this.state.formData.amount = formatted;
          const input = document.querySelector('input[inputmode="numeric"]');
          if (input && document.activeElement === input) {
            input.value = formatted;
          } else {
            this.render();
          }
        }
      },
      
      handleSubmit(e) {
        e.preventDefault();
        
        if (!this.state.formData.amount || !this.state.formData.category) {
          alert('ê¸ˆì•¡ê³¼ ì¹´í…Œê³ ë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
          return;
        }
        
        if (this.state.editingTransaction) {
          const updated = {
            ...this.state.editingTransaction,
            ...this.state.formData,
            amount: parseFloat(this.state.formData.amount.replace(/,/g, ''))
          };
          this.state.transactions = this.state.transactions.map(t => 
            t.id === this.state.editingTransaction.id ? updated : t
          );
          this.state.editingTransaction = null;
        } else {
          const newTx = {
            id: Date.now(),
            ...this.state.formData,
            amount: parseFloat(this.state.formData.amount.replace(/,/g, ''))
          };
          this.state.transactions = [newTx, ...this.state.transactions];
        }
        
        this.state.formData = {
          type: 'expense',
          amount: '',
          category: '',
          description: '',
          date: this.getLocalDateString()
        };
        this.state.showForm = false;
        this.saveData();
        this.render();
      },
      
      startEdit(transaction) {
        this.state.editingTransaction = transaction;
        this.state.formData = {
          type: transaction.type,
          amount: this.formatCurrency(transaction.amount),
          category: transaction.category,
          description: transaction.description || '',
          date: transaction.date
        };
        this.state.showForm = true;
        this.state.selectedDate = null;
        this.render();
      },
      
      deleteTransaction(id) {
        if (confirm('ì´ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          this.state.transactions = this.state.transactions.filter(t => t.id !== id);
          this.saveData();
          this.render();
        }
      },
      
      addCategory() {
        if (!this.state.newCategory.trim()) {
          alert('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
          return;
        }
        
        const type = this.state.categoryType;
        if (this.state.categories[type].includes(this.state.newCategory)) {
          alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤');
          return;
        }
        
        this.state.categories[type].push(this.state.newCategory);
        this.state.newCategory = '';
        this.saveData();
        this.render();
      },
      
      deleteCategory(type, category) {
        this.state.categories[type] = this.state.categories[type].filter(c => c !== category);
        this.saveData();
        this.render();
      },
      
      setMonthlyGoal() {
        this.state.goalInputValue = this.state.monthlyGoal > 0 ? this.formatCurrency(this.state.monthlyGoal) : '';
        this.state.showGoalInput = true;
        this.render();
      },
      
      handleGoalInput(value) {
        const cleaned = value.replace(/,/g, '');
        if (cleaned === '' || /^\d+$/.test(cleaned)) {
          const formatted = cleaned === '' ? '' : parseInt(cleaned).toLocaleString('ko-KR');
          this.state.goalInputValue = formatted;
          const input = document.querySelector('#goalInput');
          if (input && document.activeElement === input) {
            input.value = formatted;
          }
        }
      },
      
      saveMonthlyGoal() {
        const goal = parseInt(this.state.goalInputValue.replace(/,/g, '') || '0');
        this.state.monthlyGoal = goal;
        this.state.showGoalInput = false;
        this.state.goalInputValue = '';
        this.saveData();
        this.render();
      },
      
      cancelGoalInput() {
        this.state.showGoalInput = false;
        this.state.goalInputValue = '';
        this.render();
      },
      
      toggleDayOff(dateString) {
        // í–…í‹± í”¼ë“œë°± ì‹œë„
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
        
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          gainNode.gain.setValueAtTime(0, audioContext.currentTime);
          oscillator.frequency.setValueAtTime(0, audioContext.currentTime);
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.05);
        } catch (e) {}
        
        const index = this.state.daysOff.indexOf(dateString);
        if (index > -1) {
          this.state.daysOff.splice(index, 1);
          this.showToast('ğŸ’¼ ê·¼ë¬´ì¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
        } else {
          this.state.daysOff.push(dateString);
          this.showToast('ğŸ’¤ íœ´ë¬´ì¼ë¡œ ì§€ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        this.saveData();
        this.render();
      },
      
      showToast(message) {
        this.state.toastMessage = message;
        this.render();
        setTimeout(() => {
          this.state.toastMessage = '';
          this.render();
        }, 2000);
      },
      
      isDayOff(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        return this.state.daysOff.includes(dateString);
      },
      
      getTransactionsForDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        return this.state.transactions.filter(t => t.date === dateString);
      },
      
      getMonthSummary() {
        const year = this.state.currentMonth.getFullYear();
        const month = this.state.currentMonth.getMonth();
        
        return this.state.transactions
          .filter(t => {
            const [tYear, tMonth] = t.date.split('-').map(Number);
            return tYear === year && tMonth - 1 === month;
          })
          .reduce((acc, t) => {
            if (t.type === 'income') acc.income += t.amount;
            else acc.expense += t.amount;
            return acc;
          }, { income: 0, expense: 0 });
      },
      
      getWorkingDaysInfo() {
        const year = this.state.currentMonth.getFullYear();
        const month = this.state.currentMonth.getMonth();
        const today = new Date();
        const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
        
        // ì´ë‹¬ ì´ ì¼ìˆ˜
        const totalDaysInMonth = new Date(year, month + 1, 0).getDate();
        
        // ì´ë‹¬ íœ´ë¬´ì¼ ìˆ˜
        const daysOffThisMonth = this.state.daysOff.filter(dateString => {
          const [y, m] = dateString.split('-').map(Number);
          return y === year && m - 1 === month;
        }).length;
        
        // ì´ë‹¬ ì´ ê·¼ë¬´ì¼ (ì´ ì¼ìˆ˜ - íœ´ë¬´ì¼)
        const totalWorkingDays = totalDaysInMonth - daysOffThisMonth;
        
        // ë‚¨ì€ ê·¼ë¬´ì¼ (í˜„ì¬ ì›”ì¸ ê²½ìš°ë§Œ)
        let remainingWorkingDays = 0;
        if (isCurrentMonth) {
          const currentDay = today.getDate();
          const remainingDaysOffCount = this.state.daysOff.filter(dateString => {
            const [y, m, d] = dateString.split('-').map(Number);
            return y === year && m - 1 === month && d > currentDay;
          }).length;
          
          remainingWorkingDays = (totalDaysInMonth - currentDay) - remainingDaysOffCount;
        }
        
        return {
          totalDaysInMonth,
          daysOffThisMonth,
          totalWorkingDays,
          remainingWorkingDays,
          isCurrentMonth
        };
      },
      
      changeMonth(direction) {
        const newMonth = new Date(this.state.currentMonth);
        newMonth.setMonth(newMonth.getMonth() + direction);
        this.state.currentMonth = newMonth;
        this.render();
      },
      
      getDaysInMonth(date) {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        return { daysInMonth, startingDayOfWeek, year, month };
      },
      
      registerServiceWorker() {
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
              .then(reg => console.log('SW registered'))
              .catch(err => console.log('SW failed'));
          });
        }
      },
      
      render() {
        const app = document.getElementById('app');
        app.innerHTML = this.template();
      },
      
      template() {
        const summary = this.getSummary();
        const balance = summary.income - summary.expense;
        
        return `
          <div class="min-h-screen bg-gray-50">
            ${this.headerTemplate(summary, balance)}
            ${this.calendarTemplate()}
            ${this.fabTemplate()}
            ${this.state.showForm ? this.formTemplate() : ''}
            ${this.state.showCategoryManager ? this.categoryManagerTemplate() : ''}
            ${this.state.selectedDate ? this.dateDetailTemplate() : ''}
            ${this.state.showGoalInput ? this.goalInputTemplate() : ''}
            ${this.state.toastMessage ? this.toastTemplate() : ''}
          </div>
        `;
      },
      
      headerTemplate(summary, balance) {
        return `
          <div class="relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-500/90 via-indigo-500/90 to-purple-600/90 backdrop-blur-xl"></div>
            <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-white/20 via-transparent to-transparent"></div>
            
            <div class="relative text-white p-4">
              <div class="flex items-center justify-between mb-3">
                <h1 class="text-lg font-semibold tracking-tight">ğŸš• ê³ ë„ë¹„ë§Œ íƒì‹œì¥ë¶€</h1>
                <button onclick="App.state.showCategoryManager = true; App.render();" class="p-2 bg-white/15 backdrop-blur-2xl rounded-xl border border-white/20 hover:bg-white/25 transition-all">
                  âš™ï¸
                </button>
              </div>
              
              <button onclick="App.state.headerExpanded = !App.state.headerExpanded; App.render();" class="w-full bg-white/15 backdrop-blur-2xl rounded-2xl p-3 border border-white/20 shadow-xl transition-all hover:bg-white/20">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-medium">ğŸ’° ì†ìµ</span>
                  </div>
                  <div class="text-xl font-semibold">
                    ${this.formatCurrency(balance)}ì›
                  </div>
                  <div class="text-white/60">
                    ${this.state.headerExpanded ? 'â–¼' : 'â–¶'}
                  </div>
                </div>
              </button>
              
              ${this.state.headerExpanded ? `
                <div class="mt-3 space-y-2 animate-in fade-in">
                  <div class="grid grid-cols-2 gap-2">
                    <div class="bg-white/10 backdrop-blur-2xl rounded-xl p-3 border border-white/20">
                      <div class="flex items-center gap-1.5 mb-1">
                        <span class="text-xs font-medium opacity-80">ğŸ“ˆ ìˆ˜ì…</span>
                      </div>
                      <div class="text-lg font-semibold">
                        +${this.formatCurrency(summary.income)}
                      </div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-2xl rounded-xl p-3 border border-white/20">
                      <div class="flex items-center gap-1.5 mb-1">
                        <span class="text-xs font-medium opacity-80">ğŸ“‰ ì§€ì¶œ</span>
                      </div>
                      <div class="text-lg font-semibold">
                        -${this.formatCurrency(summary.expense)}
                      </div>
                    </div>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      },
      
      calendarTemplate() {
        const { daysInMonth, startingDayOfWeek, year, month } = this.getDaysInMonth(this.state.currentMonth);
        const monthSummary = this.getMonthSummary();
        const workingDaysInfo = this.getWorkingDaysInfo();
        const today = new Date();
        
        let days = [];
        
        for (let i = 0; i < startingDayOfWeek; i++) {
          days.push('<div class="aspect-square p-0.5"><div class="h-full bg-gray-100/50 rounded-xl"></div></div>');
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const dayTx = this.getTransactionsForDate(date);
          const dayIncome = dayTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
          const dayExpense = dayTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
          
          const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
          const isSunday = date.getDay() === 0;
          const isSaturday = date.getDay() === 6;
          const isDayOff = this.isDayOff(date);
          
          // ë¡œì»¬ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (UTC ë³€í™˜ ë°©ì§€)
          const dateYear = date.getFullYear();
          const dateMonth = String(date.getMonth() + 1).padStart(2, '0');
          const dateDay = String(date.getDate()).padStart(2, '0');
          const dateString = `${dateYear}-${dateMonth}-${dateDay}`;
          
          days.push(`
            <div class="aspect-square p-0.5">
              <button 
                onclick="if(!this.longPressed) { App.state.selectedDate = new Date(${year}, ${month}, ${day}); App.render(); } this.longPressed = false;" 
                oncontextmenu="event.preventDefault(); App.toggleDayOff('${dateString}'); return false;"
                ontouchstart="
                  this.longPressed = false;
                  this.classList.add('pressing');
                  this.touchTimer = setTimeout(() => { 
                    this.longPressed = true;
                    if(navigator.vibrate) navigator.vibrate(50);
                    App.toggleDayOff('${dateString}'); 
                  }, 500);
                "
                ontouchend="
                  this.classList.remove('pressing');
                  clearTimeout(this.touchTimer);
                  setTimeout(() => { this.longPressed = false; }, 100);
                "
                ontouchmove="
                  this.classList.remove('pressing');
                  clearTimeout(this.touchTimer);
                "
                class="calendar-day-btn w-full h-full ${isDayOff ? 'bg-gray-300/50' : 'bg-white/70'} backdrop-blur-xl rounded-xl p-1.5 flex flex-col items-center justify-between border transition-all ${isToday ? 'ring-2 ring-indigo-500 border-indigo-200 bg-white/90' : 'border-white/60 hover:bg-white/90'}"
                style="-webkit-touch-callout: none; -webkit-user-select: none;"
              >
                <div class="text-xs font-semibold ${isToday ? 'text-indigo-600' : isSunday ? 'text-red-500' : isSaturday ? 'text-blue-500' : 'text-gray-700'}">
                  ${day}
                </div>
                ${isDayOff ? `
                  <div class="text-lg">ğŸ’¤</div>
                ` : dayTx.length > 0 ? `
                  <div class="flex gap-1 mt-auto">
                    ${dayIncome > 0 ? '<div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>' : ''}
                    ${dayExpense > 0 ? '<div class="w-1.5 h-1.5 rounded-full bg-red-500"></div>' : ''}
                  </div>
                ` : ''}
              </button>
            </div>
          `);
        }
        
        return `
          <div class="p-4">
            <div class="flex items-center justify-between mb-4">
              <button onclick="App.changeMonth(-1)" class="p-2 bg-white/80 rounded-xl hover:bg-white shadow-sm">â—€</button>
              <h2 class="text-lg font-semibold text-gray-800">
                ${year}ë…„ ${month + 1}ì›”
              </h2>
              <button onclick="App.changeMonth(1)" class="p-2 bg-white/80 rounded-xl hover:bg-white shadow-sm">â–¶</button>
            </div>
            
            <div class="bg-white/80 backdrop-blur-xl rounded-2xl p-4 mb-4 border border-white/60 shadow-lg">
              <div class="grid grid-cols-2 gap-3 mb-3">
                <div class="bg-green-50 rounded-xl p-3">
                  <div class="text-sm text-gray-500 mb-2 font-medium">ì´ë‹¬ ìˆ˜ì…</div>
                  <div class="text-xl font-semibold text-green-600">
                    +${this.formatCurrency(monthSummary.income)}
                  </div>
                </div>
                <div class="bg-red-50 rounded-xl p-3">
                  <div class="text-sm text-gray-500 mb-2 font-medium">ì´ë‹¬ ì§€ì¶œ</div>
                  <div class="text-xl font-semibold text-red-600">
                    -${this.formatCurrency(monthSummary.expense)}
                  </div>
                </div>
              </div>
              
              ${this.state.monthlyGoal > 0 ? `
                <div class="border-t border-gray-200 pt-3">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-600">ğŸ¯ ì´ë‹¬ ëª©í‘œ</span>
                    <button onclick="App.setMonthlyGoal()" class="text-xs text-indigo-500 hover:text-indigo-600">ìˆ˜ì •</button>
                  </div>
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-lg font-semibold text-gray-800">${this.formatCurrency(this.state.monthlyGoal)}ì›</span>
                    <span class="text-sm ${monthSummary.income >= this.state.monthlyGoal ? 'text-green-600' : 'text-orange-600'} font-semibold">
                      ${Math.round((monthSummary.income / this.state.monthlyGoal) * 100)}%
                    </span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2.5 mb-3">
                    <div class="h-2.5 rounded-full transition-all ${monthSummary.income >= this.state.monthlyGoal ? 'bg-green-500' : 'bg-indigo-500'}" style="width: ${Math.min((monthSummary.income / this.state.monthlyGoal) * 100, 100)}%"></div>
                  </div>
                  
                  ${workingDaysInfo.isCurrentMonth && monthSummary.income < this.state.monthlyGoal ? `
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-3 mb-2">
                      <div class="flex items-center justify-between mb-1.5">
                        <span class="text-xs text-gray-600 font-medium">ğŸ’¼ ê·¼ë¬´ì¼ ê¸°ì¤€ í•˜ë£¨ ëª©í‘œ</span>
                        <span class="text-xs text-gray-500">${workingDaysInfo.totalWorkingDays}ì¼ ì¤‘ ${workingDaysInfo.totalWorkingDays - workingDaysInfo.remainingWorkingDays}ì¼ ê·¼ë¬´</span>
                      </div>
                      ${workingDaysInfo.remainingWorkingDays > 0 ? `
                        <div class="text-xl font-bold text-indigo-600">
                          ${this.formatCurrency(Math.ceil((this.state.monthlyGoal - monthSummary.income) / workingDaysInfo.remainingWorkingDays))}ì›
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                          ë‚¨ì€ ${workingDaysInfo.remainingWorkingDays}ì¼ ê·¼ë¬´ì¼ ê¸°ì¤€
                        </div>
                      ` : `
                        <div class="text-sm text-orange-600 font-medium">
                          ì´ë²ˆ ë‹¬ ê·¼ë¬´ì¼ì´ ëª¨ë‘ ì§€ë‚¬ìŠµë‹ˆë‹¤
                        </div>
                      `}
                    </div>
                  ` : ''}
                  
                  <div class="text-xs text-gray-500 text-right">
                    ${monthSummary.income >= this.state.monthlyGoal ? 'ëª©í‘œ ë‹¬ì„±! ğŸ‰' : `${this.formatCurrency(this.state.monthlyGoal - monthSummary.income)}ì› ë‚¨ìŒ`}
                  </div>
                </div>
              ` : `
                <div class="border-t border-gray-200 pt-3">
                  <button onclick="App.setMonthlyGoal()" class="w-full py-2.5 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100 transition-all font-medium text-sm">
                    ğŸ¯ ì´ë‹¬ ëª©í‘œ ì„¤ì •í•˜ê¸°
                  </button>
                </div>
              `}
            </div>
            
            <div class="grid grid-cols-7 gap-1 mb-2">
              ${['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].map((d, i) => `
                <div class="text-center text-sm font-semibold py-2 ${i === 0 ? 'text-red-500' : i === 6 ? 'text-blue-500' : 'text-gray-600'}">
                  ${d}
                </div>
              `).join('')}
            </div>
            
            <div class="grid grid-cols-7 gap-1.5">
              ${days.join('')}
            </div>
          </div>
        `;
      },
      
      fabTemplate() {
        return `
          <button onclick="App.state.showForm = true; App.state.editingTransaction = null; App.state.formData = { type: 'expense', amount: '', category: '', description: '', date: App.getLocalDateString() }; App.render();" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-full shadow-2xl hover:shadow-3xl transition-all z-50 flex items-center justify-center text-3xl">
            +
          </button>
        `;
      },
      
      formTemplate() {
        return `
          <div onclick="if(event.target === this) { App.state.showForm = false; App.render(); }" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-end z-50">
            <div onclick="event.stopPropagation()" class="bg-white/95 backdrop-blur-2xl w-full rounded-t-3xl p-6 max-h-[85vh] overflow-y-auto border-t border-white/60 shadow-2xl">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-800">${this.state.editingTransaction ? 'ë‚´ì—­ ìˆ˜ì •' : 'ë‚´ì—­ ì¶”ê°€'}</h2>
                <button onclick="App.state.showForm = false; App.render();" class="text-gray-400 hover:text-gray-600 transition-colors w-8 h-8 flex items-center justify-center rounded-xl hover:bg-gray-100">
                  <span class="text-2xl leading-none">Ã—</span>
                </button>
              </div>
              
              <form onsubmit="App.handleSubmit(event)" class="space-y-5">
                <div class="grid grid-cols-2 gap-3">
                  <button type="button" onclick="App.state.formData.type = 'income'; App.state.formData.category = ''; App.render();" class="py-3.5 rounded-2xl font-semibold transition-all ${this.state.formData.type === 'income' ? 'bg-gradient-to-br from-green-500 to-emerald-600 text-white shadow-lg' : 'bg-gray-100/80 text-gray-600'}">
                    ìˆ˜ì…
                  </button>
                  <button type="button" onclick="App.state.formData.type = 'expense'; App.state.formData.category = ''; App.render();" class="py-3.5 rounded-2xl font-semibold transition-all ${this.state.formData.type === 'expense' ? 'bg-gradient-to-br from-red-500 to-rose-600 text-white shadow-lg' : 'bg-gray-100/80 text-gray-600'}">
                    ì§€ì¶œ
                  </button>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2.5">ê¸ˆì•¡</label>
                  <input type="text" inputmode="numeric" value="${this.state.formData.amount}" oninput="App.handleAmountChange(this.value)" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3.5 bg-white/80 border-2 border-gray-200/80 rounded-2xl focus:border-indigo-400 focus:outline-none" required>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2.5">ì¹´í…Œê³ ë¦¬</label>
                  <div class="grid grid-cols-3 gap-2">
                    ${this.state.categories[this.state.formData.type].map(cat => `
                      <button type="button" onclick="App.state.formData.category = '${cat}'; App.render();" class="py-2.5 px-3 rounded-xl text-sm font-medium transition-all ${this.state.formData.category === cat ? 'bg-gradient-to-br from-indigo-500 to-purple-600 text-white shadow-md' : 'bg-gray-100/80 text-gray-600'}">
                        ${cat}
                      </button>
                    `).join('')}
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2.5">ë‚ ì§œ</label>
                  <input type="date" value="${this.state.formData.date}" onchange="App.state.formData.date = this.value;" class="w-full px-4 py-3.5 bg-white/80 border-2 border-gray-200/80 rounded-2xl focus:border-indigo-400 focus:outline-none appearance-none" style="-webkit-appearance: none; -moz-appearance: none;" required>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2.5">ë©”ëª¨ (ì„ íƒ)</label>
                  <input type="text" value="${this.state.formData.description}" oninput="App.state.formData.description = this.value" placeholder="ê°„ë‹¨í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3.5 bg-white/80 border-2 border-gray-200/80 rounded-2xl focus:border-indigo-400 focus:outline-none">
                </div>
                
                <button type="submit" class="w-full py-4 bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-semibold rounded-2xl shadow-lg hover:shadow-xl transition-all">
                  ${this.state.editingTransaction ? 'ìˆ˜ì •í•˜ê¸°' : 'ì¶”ê°€í•˜ê¸°'}
                </button>
              </form>
            </div>
          </div>
        `;
      },
      
      categoryManagerTemplate() {
        return `
          <div onclick="if(event.target === this) { App.state.showCategoryManager = false; App.render(); }" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-end z-50">
            <div onclick="event.stopPropagation()" class="bg-white/95 backdrop-blur-2xl w-full rounded-t-3xl p-6 max-h-[85vh] overflow-y-auto border-t border-white/60 shadow-2xl">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-800">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h2>
                <button onclick="App.state.showCategoryManager = false; App.render();" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-xl hover:bg-gray-100">
                  <span class="text-2xl">Ã—</span>
                </button>
              </div>
              
              <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="App.state.categoryType = 'income'; App.render();" class="py-3.5 rounded-2xl font-semibold transition-all ${this.state.categoryType === 'income' ? 'bg-gradient-to-br from-green-500 to-emerald-600 text-white shadow-lg' : 'bg-gray-100/80 text-gray-600'}">
                  ìˆ˜ì… ì¹´í…Œê³ ë¦¬
                </button>
                <button onclick="App.state.categoryType = 'expense'; App.render();" class="py-3.5 rounded-2xl font-semibold transition-all ${this.state.categoryType === 'expense' ? 'bg-gradient-to-br from-red-500 to-rose-600 text-white shadow-lg' : 'bg-gray-100/80 text-gray-600'}">
                  ì§€ì¶œ ì¹´í…Œê³ ë¦¬
                </button>
              </div>
              
              <div class="space-y-3 mb-6">
                ${this.state.categories[this.state.categoryType].map(cat => `
                  <div class="flex items-center justify-between bg-gray-50 rounded-xl p-3">
                    <span class="font-medium text-gray-800">${cat}</span>
                    <button onclick="if(confirm('${cat} ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) App.deleteCategory('${this.state.categoryType}', '${cat}')" class="text-red-500 hover:text-red-600 p-2">ğŸ—‘ï¸</button>
                  </div>
                `).join('')}
              </div>
              
              <div class="flex gap-2">
                <input type="text" value="${this.state.newCategory}" oninput="App.state.newCategory = this.value" onkeypress="if(event.key === 'Enter') { event.preventDefault(); App.addCategory(); }" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:outline-none">
                <button onclick="App.addCategory()" class="px-6 py-3 bg-indigo-500 text-white font-semibold rounded-xl hover:bg-indigo-600 transition-all">ì¶”ê°€</button>
              </div>
            </div>
          </div>
        `;
      },
      
      dateDetailTemplate() {
        const date = this.state.selectedDate;
        const dayTx = this.getTransactionsForDate(date).sort((a, b) => b.id - a.id);
        const dayIncome = dayTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const dayExpense = dayTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        
        return `
          <div onclick="if(event.target === this) { App.state.selectedDate = null; App.render(); }" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-end z-[90] p-4">
            <div onclick="event.stopPropagation()" class="bg-white/95 backdrop-blur-2xl rounded-3xl p-6 max-w-sm w-full mx-auto border border-white/60 shadow-2xl max-h-[70vh] overflow-y-auto">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                  ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼
                </h3>
                <button onclick="App.state.selectedDate = null; App.render();" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-xl hover:bg-gray-100">
                  <span class="text-2xl">Ã—</span>
                </button>
              </div>
              
              <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-green-50 rounded-xl p-3">
                  <div class="text-xs text-green-600 mb-1">ìˆ˜ì…</div>
                  <div class="text-lg font-semibold text-green-600">+${this.formatCurrency(dayIncome)}</div>
                </div>
                <div class="bg-red-50 rounded-xl p-3">
                  <div class="text-xs text-red-600 mb-1">ì§€ì¶œ</div>
                  <div class="text-lg font-semibold text-red-600">-${this.formatCurrency(dayExpense)}</div>
                </div>
              </div>
              
              ${dayTx.length > 0 ? `
                <div class="space-y-2">
                  ${dayTx.map(t => `
                    <div class="bg-gray-50 rounded-xl p-3">
                      <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3 flex-1">
                          <div class="w-8 h-8 rounded-lg flex items-center justify-center ${t.type === 'income' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">
                            ${t.type === 'income' ? 'ğŸ“ˆ' : 'ğŸ“‰'}
                          </div>
                          <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-800 text-sm">${t.category}</div>
                            ${t.description ? `<p class="text-xs text-gray-500 truncate">${t.description}</p>` : ''}
                          </div>
                        </div>
                        <div class="font-semibold text-sm ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                          ${t.type === 'income' ? '+' : '-'}${this.formatCurrency(t.amount)}
                        </div>
                      </div>
                      <div class="flex gap-2">
                        <button onclick="App.startEdit(${JSON.stringify(t).replace(/"/g, '&quot;')})" class="flex-1 py-2 bg-indigo-500 text-white text-sm font-medium rounded-lg hover:bg-indigo-600 transition-all">
                          âœï¸ ìˆ˜ì •
                        </button>
                        <button onclick="App.deleteTransaction(${t.id})" class="flex-1 py-2 bg-red-500 text-white text-sm font-medium rounded-lg hover:bg-red-600 transition-all">
                          ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : `
                <div class="text-center py-8 text-gray-400">
                  <p class="text-sm">ì´ ë‚ ì§œì— ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
              `}
            </div>
          </div>
        `;
      },
      
      goalInputTemplate() {
        return `
          <div onclick="if(event.target === this) App.cancelGoalInput();" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
            <div onclick="event.stopPropagation()" class="bg-white/95 backdrop-blur-2xl rounded-3xl p-6 max-w-sm w-full border border-white/60 shadow-2xl">
              <h3 class="text-xl font-semibold text-gray-800 mb-4">ğŸ¯ ì´ë‹¬ ëª©í‘œ ì„¤ì •</h3>
              
              <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2.5">ëª©í‘œ ê¸ˆì•¡ (ì›)</label>
                <input 
                  id="goalInput"
                  type="text" 
                  inputmode="numeric" 
                  value="${this.state.goalInputValue}" 
                  oninput="App.handleGoalInput(this.value)" 
                  placeholder="ëª©í‘œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”" 
                  class="w-full px-4 py-3.5 bg-white border-2 border-gray-200 rounded-2xl focus:border-indigo-400 focus:outline-none text-lg"
                  autofocus
                >
                <p class="text-xs text-gray-500 mt-2">ğŸ’¡ 0ì› ì…ë ¥ ì‹œ ëª©í‘œê°€ ì œê±°ë©ë‹ˆë‹¤</p>
              </div>
              
              <div class="grid grid-cols-2 gap-3">
                <button onclick="App.cancelGoalInput()" class="py-3.5 bg-gray-100 text-gray-700 font-semibold rounded-2xl hover:bg-gray-200 transition-all">
                  ì·¨ì†Œ
                </button>
                <button onclick="App.saveMonthlyGoal()" class="py-3.5 bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-semibold rounded-2xl shadow-lg hover:shadow-xl transition-all">
                  ì €ì¥
                </button>
              </div>
            </div>
          </div>
        `;
      },
      
      toastTemplate() {
        return `
          <div class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[110] toast-enter">
            <div class="bg-gray-900/95 backdrop-blur-xl text-white px-6 py-3.5 rounded-2xl shadow-2xl border border-white/10">
              <p class="text-sm font-medium whitespace-nowrap">${this.state.toastMessage}</p>
            </div>
          </div>
        `;
      }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
      App.init();
    });
  </script>
</body>
</html>
